<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PMG Agenda Clientes - Sistema Completo</title>
    <meta name="description" content="Sistema completo para gerenciamento de clientes inativos, ativos e novos com funcionalidades de mapa, agendamento e relatórios">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Preconnect para otimização MELHORADA -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://viacep.com.br" crossorigin>
    <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
    
    <!-- Meta tags PWA -->
    <meta name="theme-color" content="#007bff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PMG Agenda">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="48x48" href="icon-48.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    
    <!-- Leaflet CSS com integrity -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading inicial MELHORADO -->
    <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;">
        <div class="loading-spinner" style="width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1.5rem;"></div>
        <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 600;">🏢 PMG Agenda</h2>
        <p style="margin: 0; color: rgba(255,255,255,0.9); font-weight: 500; text-align: center;">Carregando sistema completo...</p>
        <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
            <div>🗺️ Inicializando mapa...</div>
            <div>📊 Carregando componentes...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <div class="header-icon">🏢</div>
                    <h1>PMG Agenda Clientes</h1>
                </div>
                <div class="header-info" id="data-info">
                    Sistema de Gestão Completo
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="inativos">
                <span class="tab-icon">🔴</span>
                <span class="tab-text">Inativos</span>
                <span class="tab-count" id="inativos-count">0</span>
            </button>
            <button class="tab-button" data-tab="ativos">
                <span class="tab-icon">🟢</span>
                <span class="tab-text">Ativos</span>
                <span class="tab-count" id="ativos-count">0</span>
            </button>
            <button class="tab-button" data-tab="novos">
                <span class="tab-icon">🆕</span>
                <span class="tab-text">Novos</span>
                <span class="tab-count" id="novos-count">0</span>
            </button>
            <button class="tab-button" data-tab="agenda">
                <span class="tab-icon">📅</span>
                <span class="tab-text">Agenda</span>
                <span class="tab-count" id="agenda-count">0</span>
            </button>
            <button class="tab-button" data-tab="mapa">
                <span class="tab-icon">🗺️</span>
                <span class="tab-text">Mapa</span>
                <span id="map-status" style="font-size: 0.7rem; opacity: 0.8;">Carregando...</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-container">
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">📊</div>
                        <label for="file-input" class="upload-label">
                            Carregar Planilha de Clientes
                        </label>
                        <p class="upload-description">
                            Arraste e solte o arquivo Excel (.xlsx) aqui ou clique para selecionar
                        </p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
                    </div>
                </div>
            </section>

            <!-- Progress Section MELHORADA -->
            <section id="progress-section" class="progress-section" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <h3>🗺️ Processando Localização dos Clientes</h3>
                        <div class="progress-stats">
                            <span id="progress-text">Preparando...</span>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        <div id="current-client" style="font-weight: 500; color: #495057; margin: 1rem 0;">Aguardando...</div>
                        <div class="progress-info" style="font-size: 0.9rem; color: #6c757d;">
                            <div>✅ ViaCEP: Consulta de CEPs</div>
                            <div>🌐 Nominatim: Geocodificação precisa</div>
                            <div>📍 Fallback: Localização aproximada</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab Contents -->
            <div id="inativos-tab" class="tab-content active">
                <div class="content-header">
                    <h2 class="section-title">
                        🔴 Clientes Inativos
                    </h2>
                    
                    <!-- Filters -->
                    <div class="filters-container">
                        <div class="filter-group">
                            <label class="filter-label">Ordenar por:</label>
                            <select id="sortOption" class="filter-select">
                                <option value="nome-az">Nome A-Z</option>
                                <option value="nome-za">Nome Z-A</option>
                                <option value="cidade-az">Cidade A-Z</option>
                                <option value="cidade-za">Cidade Z-A</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="client-list-container">
                    <div id="client-list" class="client-list">
                        <div class="empty-state">
                            Carregue uma planilha para visualizar os clientes inativos
                        </div>
                    </div>
                </div>
            </div>

            <div id="ativos-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        🟢 Clientes Ativos
                    </h2>
                </div>
                
                <div class="client-list-container">
                    <div id="ativos-list" class="client-list">
                        <div class="empty-state">
                            Carregue uma planilha para visualizar os clientes ativos
                        </div>
                    </div>
                </div>
            </div>

            <div id="novos-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        🆕 Clientes Novos
                    </h2>
                </div>
                
                <div class="client-list-container">
                    <div id="novos-list" class="client-list">
                        <div class="empty-state">
                            Carregue uma planilha para visualizar os clientes novos
                        </div>
                    </div>
                </div>
            </div>

            <div id="agenda-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        📅 Agenda de Compromissos
                    </h2>
                </div>
                
                <div class="agenda-container">
                    <div id="agenda-list" class="agenda-list">
                        <div class="empty-state">
                            Nenhum agendamento encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="mapa-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        🗺️ Mapa dos Clientes
                    </h2>
                    <div id="map-controls" class="action-buttons">
                        <button id="refresh-map" class="btn btn-primary">
                            <span>🔄</span> Atualizar Mapa
                        </button>
                        <button id="clear-cache" class="btn btn-secondary">
                            <span>🧹</span> Limpar Cache
                        </button>
                    </div>
                </div>
                
                <div class="map-container">
                    <div id="map" class="map-area" style="height: 500px; width: 100%;">
                        <!-- Mapa será inicializado automaticamente aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Cliente</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conteúdo preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Error Container -->
    <div id="error-container"></div>

    <!-- Scripts Core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <!-- Scripts Próprios OTIMIZADOS -->
    <script src="cep-processor.js"></script>
    <script src="geocoding-service.js"></script>
    <script src="dbManager.js"></script>
    <script src="client-manager.js"></script>
    <script src="script.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then((registration) => {
                        console.log('✅ SW registrado:', registration.scope);
                    })
                    .catch((registrationError) => {
                        console.log('❌ Falha SW:', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
