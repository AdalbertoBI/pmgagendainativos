<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMG - Agenda Clientes</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" 
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" 
          crossorigin=""/>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
    
    <style>
        /* Loading Screen */
        #loading-indicator {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }
        
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Carregando sistema...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-title">
                    <span class="header-icon">📋</span>
                    <h1>PMG - Agenda Clientes</h1>
                </div>
                <div class="header-info">
                    <span id="data-info"></span>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="inativos">
                <span class="tab-icon">🔴</span>
                <span class="tab-text">Inativos</span>
                <span id="inativos-count" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="ativos">
                <span class="tab-icon">🟢</span>
                <span class="tab-text">Ativos</span>
                <span id="ativos-count" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="novos">
                <span class="tab-icon">🆕</span>
                <span class="tab-text">Novos</span>
                <span id="novos-count" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="agenda">
                <span class="tab-icon">📅</span>
                <span class="tab-text">Agenda</span>
                <span id="agenda-count" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="mapa">
                <span class="tab-icon">🗺️</span>
                <span class="tab-text">Mapa</span>
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Upload Section -->
            <section class="upload-section">
                <div class="upload-container">
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">📁</div>
                        <label for="file-input" class="upload-label">
                            Selecionar Planilha Excel
                        </label>
                        <p class="upload-description">
                            Arraste e solte o arquivo aqui ou clique para selecionar
                        </p>
                        <input type="file" id="file-input" class="file-input" accept=".xlsx,.xls">
                    </div>
                </div>
            </section>

            <!-- Tab Content: Inativos -->
            <div id="inativos-tab" class="tab-content active">
                <div class="content-header">
                    <h2 class="section-title">
                        <span>🔴</span>
                        Clientes Inativos
                    </h2>
                    
                    <!-- Filters -->
                    <div class="filters-container">
                        <div class="filter-group">
                            <label class="filter-label">Ordenar por:</label>
                            <select id="sortOption" class="filter-select">
                                <option value="nome-az">Nome A-Z</option>
                                <option value="nome-za">Nome Z-A</option>
                                <option value="cidade-az">Cidade A-Z</option>
                                <option value="cidade-za">Cidade Z-A</option>
                            </select>
                        </div>
                        
                        <div class="filter-group cidade-filter">
                            <label class="filter-label">Filtrar por cidade:</label>
                            <div class="cidade-selector" id="cidade-selector">
                                <span id="cidade-selected">Todas as cidades</span>
                                <span class="selector-arrow">▼</span>
                            </div>
                            <div class="cidade-list escondido" id="cidade-list">
                                <!-- Cidades serão preenchidas dinamicamente -->
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="atualizar-mapa">
                                <span>🗺️</span> Atualizar Mapa
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="client-list-container">
                    <div id="client-list" class="client-list">
                        <div class="empty-state">
                            Nenhum cliente inativo encontrado. Faça o upload de uma planilha.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Ativos -->
            <div id="ativos-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        <span>🟢</span>
                        Clientes Ativos
                    </h2>
                </div>
                
                <div class="client-list-container">
                    <div id="ativos-list" class="client-list">
                        <div class="empty-state">
                            Nenhum cliente ativo encontrado.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Novos -->
            <div id="novos-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        <span>🆕</span>
                        Clientes Novos
                    </h2>
                </div>
                
                <div class="client-list-container">
                    <div id="novos-list" class="client-list">
                        <div class="empty-state">
                            Nenhum cliente novo encontrado.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Agenda -->
            <div id="agenda-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        <span>📅</span>
                        Agenda de Visitas
                    </h2>
                </div>
                
                <div class="agenda-container">
                    <div id="agenda-list" class="agenda-list">
                        <div class="empty-state">
                            Nenhum agendamento encontrado.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Mapa -->
            <div id="mapa-tab" class="tab-content">
                <div class="content-header">
                    <h2 class="section-title">
                        <span>🗺️</span>
                        Mapa de Clientes
                    </h2>
                </div>
                
                <div class="map-container">
                    <div id="map" class="map-area">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Carregando mapa...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes do Cliente</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Error Messages Container -->
    <div id="error-container" style="position: fixed; top: 80px; right: 20px; z-index: 10001;"></div>

    <!-- Scripts -->
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" 
            integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" 
            crossorigin="anonymous"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" 
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" 
            crossorigin=""></script>

    <!-- App Scripts -->
    <script src="dbManager.js"></script>
    <script src="client-manager.js"></script>
    <script src="map.js"></script>
    <script src="script.js"></script>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => console.log('SW registered:', registration))
                .catch(error => console.log('SW registration failed:', error));
        }
        
        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showErrorMessage('Erro no sistema: ' + e.message);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            showErrorMessage('Erro de sistema não tratado');
        });
    </script>
</body>
</html>
