<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMG - Gest√£o de Clientes v2.1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS para mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>PMG - Sistema Funcionando ‚úÖ</h3>
            <p id="loading-status">Inicializando sistema corrigido...</p>
            <div class="loading-progress">
                <div id="loading-bar" class="loading-bar"></div>
            </div>
            <div class="loading-details" id="loading-details">
                <small>Upload corrigido - bot√µes funcionais...</small>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <img src="logo.png" alt="PMG Logo" class="logo" onerror="this.style.display='none'">
                <h1>PMG - Sistema de Gest√£o</h1>
                <span class="version-badge">v2.1 ‚úÖ</span>
            </div>
            <div class="header-right">
                <!-- Indicadores de sistema -->
                <div class="system-indicators">
                    <div id="connection-indicator" class="indicator" title="Status da conex√£o">
                        <i class="fas fa-wifi" style="color: #28a745;"></i>
                    </div>
                    <div id="api-indicator" class="indicator" title="Status das APIs">
                        <i class="fas fa-cloud" style="color: #28a745;"></i>
                        <span id="api-count" class="badge">4</span>
                    </div>
                    <div id="sync-indicator" class="indicator" title="Status de sincroniza√ß√£o">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div id="notification-indicator" class="indicator" title="Notifica√ß√µes">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count" class="badge">0</span>
                    </div>
                </div>
                
                <!-- Menu de usu√°rio -->
                <div class="user-menu">
                    <button class="btn-icon" id="user-menu-btn" title="Menu do usu√°rio">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div id="user-dropdown" class="dropdown-menu">
                        <a href="#" id="show-api-status"><i class="fas fa-cloud"></i> Status das APIs</a>
                        <a href="#" id="show-settings"><i class="fas fa-cog"></i> Configura√ß√µes</a>
                        <a href="#" id="show-stats"><i class="fas fa-chart-bar"></i> Estat√≠sticas</a>
                        <a href="#" id="export-data"><i class="fas fa-download"></i> Exportar</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" id="show-about"><i class="fas fa-info-circle"></i> Sobre</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="tab-navigation">
        <div class="tab-container">
            <button class="tab-button active" data-tab="inativos" id="tab-inativos">
                <i class="fas fa-bed"></i>
                <span>Inativos</span>
                <span id="count-inativos" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="ativos" id="tab-ativos">
                <i class="fas fa-check-circle"></i>
                <span>Ativos</span>
                <span id="count-ativos" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="novos" id="tab-novos">
                <i class="fas fa-star"></i>
                <span>Novos</span>
                <span id="count-novos" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="agenda" id="tab-agenda">
                <i class="fas fa-calendar-alt"></i>
                <span>Agenda</span>
                <span id="count-agenda" class="tab-count">0</span>
            </button>
            <button class="tab-button" data-tab="mapa" id="tab-mapa">
                <i class="fas fa-map-marker-alt"></i>
                <span>Mapa</span>
                <span id="count-mapa" class="tab-count">0</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Tab: Inativos -->
        <div class="tab-content active" data-tab="inativos" id="content-inativos">
            <div class="tab-header">
                <h2><i class="fas fa-bed"></i> Clientes Inativos</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" id="upload-inativos">
                        <i class="fas fa-upload"></i> Upload Excel/CSV
                    </button>
                    <button class="btn btn-secondary" id="export-inativos">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn btn-info" id="enrich-inativos">
                        <i class="fas fa-magic"></i> Enriquecer Dados
                    </button>
                </div>
            </div>
            
            <!-- Filtros e pesquisa -->
            <div class="filters-section">
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-inativos" placeholder="Pesquisar clientes inativos...">
                        <button class="btn-clear" id="clear-search-inativos" title="Limpar pesquisa">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label>Ordenar por:</label>
                        <select id="sort-inativos">
                            <option value="nome-az">Nome A-Z</option>
                            <option value="nome-za">Nome Z-A</option>
                            <option value="cidade-az">Cidade A-Z</option>
                            <option value="cidade-za">Cidade Z-A</option>
                            <option value="data-novo">Mais Novos</option>
                            <option value="data-antigo">Mais Antigos</option>
                            <option value="completude">Dados Completos</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Segmento:</label>
                        <select id="filter-segmento-inativos">
                            <option value="">Todos</option>
                            <option value="Pizzaria">Pizzaria</option>
                            <option value="Restaurante">Restaurante</option>
                            <option value="Padaria">Padaria</option>
                            <option value="Supermercado">Supermercado</option>
                            <option value="Hamburgueria">Hamburgueria</option>
                            <option value="Confeitaria">Confeitaria</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Cidade:</label>
                        <select id="filter-cidade-inativos">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-outline" id="reset-filters-inativos">
                        <i class="fas fa-undo"></i> Limpar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Lista de clientes -->
            <div class="client-list-container">
                <div class="list-header">
                    <div class="list-info">
                        <span id="list-count-inativos">0 clientes encontrados</span>
                        <div class="list-actions">
                            <button class="btn-sm btn-outline" id="select-all-inativos">
                                <i class="fas fa-check-square"></i> Selecionar Todos
                            </button>
                            <button class="btn-sm btn-success" id="enrich-selected-inativos" disabled>
                                <i class="fas fa-magic"></i> Enriquecer Selecionados
                            </button>
                            <button class="btn-sm btn-danger" id="delete-selected-inativos" disabled>
                                <i class="fas fa-trash"></i> Excluir Selecionados
                            </button>
                        </div>
                    </div>
                </div>
                <ul id="client-list" class="client-list">
                    <div class="no-results">
                        <i class="fas fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <p>Nenhum cliente inativo encontrado</p>
                        <p><small>Fa√ßa upload de uma planilha para come√ßar</small></p>
                    </div>
                </ul>
            </div>
        </div>

        <!-- Tab: Ativos -->
        <div class="tab-content" data-tab="ativos" id="content-ativos">
            <div class="tab-header">
                <h2><i class="fas fa-check-circle"></i> Clientes Ativos</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" id="upload-ativos">
                        <i class="fas fa-upload"></i> Upload Excel/CSV
                    </button>
                    <button class="btn btn-secondary" id="export-ativos">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn btn-success" id="new-client-ativos">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                    <button class="btn btn-info" id="enrich-ativos">
                        <i class="fas fa-magic"></i> Enriquecer Dados
                    </button>
                </div>
            </div>
            
            <div class="client-list-container">
                <div class="list-header">
                    <span id="list-count-ativos">0 clientes encontrados</span>
                </div>
                <ul id="ativos-list" class="client-list">
                    <div class="no-results">
                        <i class="fas fa-check-circle" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <p>Nenhum cliente ativo encontrado</p>
                        <p><small>Fa√ßa upload de uma planilha ou adicione manualmente</small></p>
                    </div>
                </ul>
            </div>
        </div>

        <!-- Tab: Novos -->
        <div class="tab-content" data-tab="novos" id="content-novos">
            <div class="tab-header">
                <h2><i class="fas fa-star"></i> Clientes Novos</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" id="upload-novos">
                        <i class="fas fa-upload"></i> Upload Excel/CSV
                    </button>
                    <button class="btn btn-secondary" id="export-novos">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn btn-success" id="new-client-novos">
                        <i class="fas fa-plus"></i> Novo Cliente
                    </button>
                    <button class="btn btn-info" id="enrich-novos">
                        <i class="fas fa-magic"></i> Enriquecer Dados
                    </button>
                </div>
            </div>
            
            <div class="client-list-container">
                <div class="list-header">
                    <span id="list-count-novos">0 clientes encontrados</span>
                </div>
                <ul id="novos-list" class="client-list">
                    <div class="no-results">
                        <i class="fas fa-star" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                        <p>Nenhum cliente novo encontrado</p>
                        <p><small>Fa√ßa upload de uma planilha ou adicione manualmente</small></p>
                    </div>
                </ul>
            </div>
        </div>

        <!-- Tab: Agenda -->
        <div class="tab-content" data-tab="agenda" id="content-agenda">
            <div class="tab-header">
                <h2><i class="fas fa-calendar-alt"></i> Agenda de Visitas</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" id="new-appointment">
                        <i class="fas fa-plus"></i> Novo Agendamento
                    </button>
                    <button class="btn btn-secondary" id="export-agenda">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <button class="btn btn-success" id="sync-calendar">
                        <i class="fas fa-sync"></i> Sincronizar
                    </button>
                    <button class="btn btn-info" id="check-holidays">
                        <i class="fas fa-calendar-check"></i> Verificar Feriados
                    </button>
                </div>
            </div>
            
            <div class="agenda-container">
                <div class="agenda-view" id="calendar-view">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="btn-icon" id="previous-month">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h3 id="calendar-title">Janeiro 2025</h3>
                            <button class="btn-icon" id="next-month">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="view-toggles">
                            <button class="btn-sm active" data-view="calendar" id="view-calendar">
                                <i class="fas fa-calendar"></i> Calend√°rio
                            </button>
                            <button class="btn-sm" data-view="list" id="view-list">
                                <i class="fas fa-list"></i> Lista
                            </button>
                        </div>
                    </div>
                    
                    <div class="calendar-grid" id="calendar-grid">
                        <div class="no-results">
                            <i class="fas fa-calendar-alt" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p>Calend√°rio ser√° carregado aqui</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Mapa -->
        <div class="tab-content" data-tab="mapa" id="content-mapa">
            <div class="tab-header">
                <h2><i class="fas fa-map-marker-alt"></i> Mapa de Clientes</h2>
                <div class="tab-actions">
                    <button class="btn btn-primary" id="load-markers">
                        <i class="fas fa-map-pin"></i> Carregar Marcadores
                    </button>
                    <button class="btn btn-secondary" id="export-markers">
                        <i class="fas fa-download"></i> Exportar Vis√≠veis
                    </button>
                    <button class="btn btn-success" id="plan-route">
                        <i class="fas fa-route"></i> Planejar Rota
                    </button>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map" class="map-element">
                    <div class="map-loading">
                        <i class="fas fa-map-marked-alt"></i>
                        <p>Carregando mapa OpenStreetMap...</p>
                        <p><small>‚úÖ Sistema funcionando</small></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CORRIGIDO: Upload Modal com bot√µes sempre vis√≠veis -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-upload"></i>
                    Upload de Planilha
                </h3>
                <button class="modal-close" id="close-upload-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- √Årea de sele√ß√£o de arquivo -->
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">
                            <h4>Clique aqui para selecionar arquivo</h4>
                            <p>Formatos suportados: .xlsx, .xls, .csv</p>
                            <p>Tamanho m√°ximo: 50MB</p>
                            <p><small>üîß Sistema de upload corrigido</small></p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                </div>
                
                <!-- Informa√ß√µes do arquivo -->
                <div class="upload-info" id="uploadInfo" style="display: none;">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                            <div class="file-status" id="fileStatus">
                                <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                <span>Arquivo carregado com sucesso!</span>
                            </div>
                        </div>
                        <button class="btn-remove" id="remove-file">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <!-- An√°lise do arquivo -->
                    <div class="file-analysis" id="fileAnalysis" style="display: none;">
                        <h4>üìä An√°lise do Arquivo</h4>
                        <div id="analysisResults"></div>
                    </div>
                    
                    <!-- Preview dos dados -->
                    <div class="data-preview" id="dataPreview" style="display: none;">
                        <h4>üëÅÔ∏è Preview dos Dados <span id="previewCount">(0 registros)</span></h4>
                        <div class="preview-table-container">
                            <table id="previewTable" class="preview-table">
                                <!-- Ser√° preenchido dinamicamente -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CORRIGIDO: Footer sempre vis√≠vel -->
            <div class="modal-footer" id="uploadModalFooter">
                <div class="upload-options">
                    <label class="checkbox-label">
                        <input type="checkbox" id="updateExisting" checked>
                        <span class="checkmark"></span>
                        Atualizar registros existentes
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="validateData" checked>
                        <span class="checkmark"></span>
                        Validar dados automaticamente
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="enrichData" checked>
                        <span class="checkmark"></span>
                        Enriquecer dados com APIs funcionais
                    </label>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-upload">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" id="uploadButton">
                        <i class="fas fa-upload"></i>
                        Processar Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-icon">
                        <div class="spinner"></div>
                    </div>
                    <div class="progress-info">
                        <h4 id="progressTitle">Processando...</h4>
                        <p id="progressMessage">Aguarde enquanto processamos sua solicita√ß√£o.</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-stats" id="progressStats"></div>
                        <div class="api-status" id="apiStatus">‚úÖ APIs funcionais</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Status Modal -->
    <div id="apiStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud"></i> Status das APIs ‚úÖ</h3>
                <button class="modal-close" id="close-api-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="apiStatusList" class="api-status-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
                <div class="api-actions">
                    <button class="btn btn-primary" id="test-all-apis">
                        <i class="fas fa-test-tube"></i> Testar APIs Funcionais
                    </button>
                    <button class="btn btn-secondary" id="refresh-api-status">
                        <i class="fas fa-refresh"></i> Atualizar Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container">
        <!-- Toasts ser√£o adicionados dinamicamente -->
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- CORRIGIDO: Sistema de upload com bot√µes sempre vis√≠veis -->
    <script>
        // Vari√°veis globais
        window.systemInitialized = false;
        window.scriptsLoaded = false;
        window.currentUploadFile = null;
        window.currentUploadCategory = 'clients';
        
        // Lista de scripts em ordem
        const requiredScripts = [
            'db-manager.js',
            'api-manager.js',
            'data-handler.js',
            'modal-manager.js',
            'agenda-manager.js',
            'client-manager.js',
            'map-manager.js',
            'app.js'
        ];
        
        // Fun√ß√£o para carregar scripts sequencialmente
        function loadScriptsSequentially() {
            let currentIndex = 0;
            
            function loadNextScript() {
                if (currentIndex >= requiredScripts.length) {
                    console.log('‚úÖ Todos os scripts carregados');
                    window.scriptsLoaded = true;
                    setupEventListenersFixed();
                    return;
                }
                
                const scriptName = requiredScripts[currentIndex];
                const script = document.createElement('script');
                script.src = scriptName;
                
                script.onload = () => {
                    console.log(`‚úÖ Script carregado: ${scriptName}`);
                    currentIndex++;
                    setTimeout(loadNextScript, 100);
                };
                
                script.onerror = () => {
                    console.error(`‚ùå Erro ao carregar: ${scriptName}`);
                    currentIndex++;
                    setTimeout(loadNextScript, 100);
                };
                
                document.head.appendChild(script);
            }
            
            loadNextScript();
        }
        
        // CORRIGIDO: Event listeners com bot√µes sempre vis√≠veis
        function setupEventListenersFixed() {
            console.log('üîß Configurando event listeners corrigidos...');
            
            // ============= NAVEGA√á√ÉO ENTRE ABAS =============
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    console.log(`üìë Clicando na aba: ${tabName}`);
                    switchTabFixed(tabName);
                });
            });
            
            // ============= UPLOAD DE ARQUIVOS - CORRIGIDO =============
            
            // Bot√µes de upload
            document.getElementById('upload-inativos')?.addEventListener('click', () => openUploadModalFixed('clients'));
            document.getElementById('upload-ativos')?.addEventListener('click', () => openUploadModalFixed('ativos'));
            document.getElementById('upload-novos')?.addEventListener('click', () => openUploadModalFixed('novos'));
            
            // √Årea de upload
            document.getElementById('uploadArea')?.addEventListener('click', function() {
                console.log('üìÅ Clicando na √°rea de upload');
                document.getElementById('fileInput').click();
            });
            
            // CORRIGIDO: Input de arquivo com l√≥gica de bot√µes
            document.getElementById('fileInput')?.addEventListener('change', function(e) {
                console.log('üìÑ Arquivo selecionado via input');
                handleFileSelectFixed(e);
            });
            
            // CORRIGIDO: Bot√µes do modal sempre funcionais
            document.getElementById('close-upload-modal')?.addEventListener('click', closeUploadModalFixed);
            document.getElementById('cancel-upload')?.addEventListener('click', closeUploadModalFixed);
            document.getElementById('uploadButton')?.addEventListener('click', processUploadFixed);
            document.getElementById('remove-file')?.addEventListener('click', removeFileFixed);
            
            // ============= MENU DO USU√ÅRIO =============
            document.getElementById('user-menu-btn')?.addEventListener('click', function() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.classList.toggle('show');
            });
            
            // ============= MODAL DE API STATUS =============
            document.getElementById('show-api-status')?.addEventListener('click', function(e) {
                e.preventDefault();
                openAPIStatusModal();
            });
            document.getElementById('close-api-modal')?.addEventListener('click', closeAPIStatusModal);
            document.getElementById('test-all-apis')?.addEventListener('click', testAllAPIsFixed);
            document.getElementById('refresh-api-status')?.addEventListener('click', refreshAPIStatusFixed);
            
            // ============= PESQUISAS =============
            document.getElementById('search-inativos')?.addEventListener('input', function(e) {
                searchClientsFixed('inativos', e.target.value);
            });
            document.getElementById('search-ativos')?.addEventListener('input', function(e) {
                searchClientsFixed('ativos', e.target.value);
            });
            document.getElementById('search-novos')?.addEventListener('input', function(e) {
                searchClientsFixed('novos', e.target.value);
            });
            
            // ============= ENRIQUECIMENTO =============
            document.getElementById('enrich-inativos')?.addEventListener('click', () => enrichDataFixed('inativos'));
            document.getElementById('enrich-ativos')?.addEventListener('click', () => enrichDataFixed('ativos'));
            document.getElementById('enrich-novos')?.addEventListener('click', () => enrichDataFixed('novos'));
            
            // ============= FILTROS =============
            document.getElementById('sort-inativos')?.addEventListener('change', () => applyFiltersFixed('inativos'));
            document.getElementById('sort-ativos')?.addEventListener('change', () => applyFiltersFixed('ativos'));
            document.getElementById('sort-novos')?.addEventListener('change', () => applyFiltersFixed('novos'));
            
            // ============= CLIQUE GLOBAL =============
            document.addEventListener('click', function(e) {
                // Fechar dropdown se clicar fora
                if (!e.target.closest('.user-menu')) {
                    document.getElementById('user-dropdown')?.classList.remove('show');
                }
                
                // Fechar modais se clicar no overlay
                if (e.target.classList.contains('modal')) {
                    closeAllModalsFixed();
                }
            });
            
            console.log('‚úÖ Event listeners configurados com sucesso - UPLOAD CORRIGIDO');
        }
        
        // ============= FUN√á√ïES CORRIGIDAS =============
        
        function switchTabFixed(tabName) {
            console.log(`üîÑ Alternando para aba: ${tabName}`);
            
            try {
                // Remover active de todas as abas
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Ativar aba selecionada
                const activeButton = document.querySelector(`[data-tab="${tabName}"]`);
                const activeContent = document.querySelector(`#content-${tabName}`);
                
                if (activeButton) {
                    activeButton.classList.add('active');
                    console.log(`‚úÖ Bot√£o da aba ${tabName} ativado`);
                }
                
                if (activeContent) {
                    activeContent.classList.add('active');
                    console.log(`‚úÖ Conte√∫do da aba ${tabName} ativado`);
                }
                
                // Chamar fun√ß√£o do app se dispon√≠vel
                if (window.pmgApp && window.pmgApp.switchToTab) {
                    window.pmgApp.switchToTab(tabName);
                }
                
            } catch (error) {
                console.error(`‚ùå Erro ao alternar aba: ${error.message}`);
            }
        }
        
        // CORRIGIDO: Modal de upload com bot√µes sempre vis√≠veis
        function openUploadModalFixed(category) {
            console.log(`üìÅ Abrindo modal de upload para: ${category}`);
            window.currentUploadCategory = category;
            
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // CORRIGIDO: Garantir que footer esteja sempre vis√≠vel
                const footer = document.getElementById('uploadModalFooter');
                if (footer) {
                    footer.style.display = 'block';
                }
                
                // CORRIGIDO: Garantir que bot√£o esteja sempre vis√≠vel e habilitado por padr√£o
                const uploadButton = document.getElementById('uploadButton');
                if (uploadButton) {
                    uploadButton.style.display = 'inline-flex';
                    uploadButton.style.visibility = 'visible';
                    // Inicialmente desabilitado at√© selecionar arquivo
                    uploadButton.disabled = true;
                }
                
                // Limpar estado anterior
                resetUploadModal();
            }
        }
        
        function closeUploadModalFixed() {
            console.log('‚ùå Fechando modal de upload');
            const modal = document.getElementById('uploadModal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // Limpar dados
            resetUploadModal();
            window.currentUploadFile = null;
        }
        
        // CORRIGIDO: Reset do modal mantendo bot√µes vis√≠veis
        function resetUploadModal() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            
            const uploadInfo = document.getElementById('uploadInfo');
            if (uploadInfo) uploadInfo.style.display = 'none';
            
            const fileAnalysis = document.getElementById('fileAnalysis');
            if (fileAnalysis) fileAnalysis.style.display = 'none';
            
            const dataPreview = document.getElementById('dataPreview');
            if (dataPreview) dataPreview.style.display = 'none';
            
            // CORRIGIDO: Manter bot√£o vis√≠vel mas desabilitado
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton) {
                uploadButton.disabled = true;
                uploadButton.style.display = 'inline-flex'; // SEMPRE VIS√çVEL
                uploadButton.style.visibility = 'visible'; // SEMPRE VIS√çVEL
            }
            
            // CORRIGIDO: Manter footer sempre vis√≠vel
            const footer = document.getElementById('uploadModalFooter');
            if (footer) {
                footer.style.display = 'block'; // SEMPRE VIS√çVEL
            }
        }
        
        // CORRIGIDO: Sele√ß√£o de arquivo com bot√µes sempre vis√≠veis
        function handleFileSelectFixed(event) {
            console.log('üìÅ Arquivo selecionado - VERS√ÉO CORRIGIDA');
            const file = event.target.files[0];
            
            if (!file) {
                console.warn('‚ö†Ô∏è Nenhum arquivo selecionado');
                return;
            }
            
            console.log(`üìÑ Arquivo: ${file.name} (${formatFileSize(file.size)})`);
            
            // Validar arquivo
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel',
                'text/csv'
            ];
            
            const isValidType = validTypes.includes(file.type) || file.name.match(/\.(xlsx|xls|csv)$/i);
            
            if (!isValidType) {
                showToastFixed('Tipo de arquivo n√£o suportado. Use Excel (.xlsx, .xls) ou CSV.', 'error');
                return;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                showToastFixed('Arquivo muito grande. M√°ximo 50MB.', 'error');
                return;
            }
            
            // CORRIGIDO: Mostrar informa√ß√µes sem ocultar bot√µes
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            
            const uploadInfo = document.getElementById('uploadInfo');
            if (uploadInfo) {
                uploadInfo.style.display = 'block';
            }
            
            // CORRIGIDO: HABILITAR bot√£o mas manter SEMPRE VIS√çVEL
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton) {
                uploadButton.disabled = false; // HABILITAR
                uploadButton.style.display = 'inline-flex'; // FOR√áAR VISIBILIDADE
                uploadButton.style.visibility = 'visible'; // FOR√áAR VISIBILIDADE
                uploadButton.style.opacity = '1'; // FOR√áAR OPACIDADE
            }
            
            // CORRIGIDO: GARANTIR que footer esteja vis√≠vel
            const footer = document.getElementById('uploadModalFooter');
            if (footer) {
                footer.style.display = 'block'; // FOR√áAR VISIBILIDADE
                footer.style.visibility = 'visible'; // FOR√áAR VISIBILIDADE
            }
            
            window.currentUploadFile = file;
            
            // An√°lise do arquivo se dispon√≠vel
            if (window.pmgApp && window.pmgApp.excelProcessor) {
                window.pmgApp.excelProcessor.analyzeFile(file).then(analysis => {
                    showFileAnalysisFixed(analysis);
                }).catch(error => {
                    console.warn('Erro na an√°lise:', error);
                });
            }
            
            showToastFixed('‚úÖ Arquivo carregado! Bot√£o de upload dispon√≠vel.', 'success');
        }
        
        // CORRIGIDO: Processamento mantendo bot√µes vis√≠veis
        function processUploadFixed() {
            console.log('üöÄ Iniciando processamento do upload - VERS√ÉO CORRIGIDA');
            
            if (!window.currentUploadFile) {
                showToastFixed('Nenhum arquivo selecionado', 'warning');
                return;
            }
            
            // CORRIGIDO: Verificar se bot√£o est√° vis√≠vel antes de processar
            const uploadButton = document.getElementById('uploadButton');
            console.log('üîç Estado do bot√£o:', {
                existe: !!uploadButton,
                visivel: uploadButton ? uploadButton.style.display : 'N/A',
                habilitado: uploadButton ? !uploadButton.disabled : 'N/A'
            });
            
            if (window.pmgApp && window.pmgApp.processUpload) {
                // Desabilitar bot√£o durante processamento mas manter vis√≠vel
                if (uploadButton) {
                    uploadButton.disabled = true;
                    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                }
                
                window.pmgApp.processUpload().then(() => {
                    // Reabilitar bot√£o ap√≥s processamento
                    if (uploadButton) {
                        uploadButton.disabled = false;
                        uploadButton.innerHTML = '<i class="fas fa-upload"></i> Processar Upload';
                    }
                }).catch(error => {
                    console.error('Erro no processamento:', error);
                    // Reabilitar bot√£o mesmo com erro
                    if (uploadButton) {
                        uploadButton.disabled = false;
                        uploadButton.innerHTML = '<i class="fas fa-upload"></i> Processar Upload';
                    }
                });
            } else {
                showToastFixed('Sistema de processamento n√£o dispon√≠vel', 'error');
            }
        }
        
        function removeFileFixed() {
            console.log('üóëÔ∏è Removendo arquivo');
            
            resetUploadModal();
            window.currentUploadFile = null;
            
            showToastFixed('Arquivo removido', 'info');
        }
        
        function showFileAnalysisFixed(analysis) {
            const analysisDiv = document.getElementById('fileAnalysis');
            const resultsDiv = document.getElementById('analysisResults');
            
            if (!analysisDiv || !resultsDiv) return;
            
            let html = `
                <div class="analysis-item">
                    <strong>üìä Formato:</strong> ${analysis.format}
                </div>
                <div class="analysis-item">
                    <strong>üìà Registros estimados:</strong> ${analysis.estimatedRows}
                </div>
                <div class="analysis-item">
                    <strong>üìã Colunas detectadas:</strong> ${analysis.columns ? analysis.columns.length : 'Analisando...'}
                </div>
                <div class="analysis-item">
                    <strong>‚≠ê Qualidade estimada:</strong> ${analysis.quality}
                </div>
            `;
            
            if (analysis.columns && analysis.columns.length > 0) {
                html += `
                    <div class="analysis-item">
                        <strong>üè∑Ô∏è Principais colunas:</strong><br>
                        <div class="columns-preview">
                            ${analysis.columns.slice(0, 5).map(col => 
                                `<span class="column-tag">${col}</span>`
                            ).join('')}
                            ${analysis.columns.length > 5 ? `<span class="more-columns">+${analysis.columns.length - 5} mais</span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            analysisDiv.style.display = 'block';
        }
        
        function searchClientsFixed(tab, searchTerm) {
            console.log(`üîç Pesquisando em ${tab}: "${searchTerm}"`);
            
            if (window.pmgApp && window.pmgApp.searchClients) {
                window.pmgApp.searchClients(tab, searchTerm);
            }
        }
        
        function enrichDataFixed(tab) {
            console.log(`‚ú® Enriquecendo dados de: ${tab}`);
            
            if (window.pmgApp && window.pmgApp.enrichData) {
                window.pmgApp.enrichData(tab);
            } else {
                showToastFixed('Sistema de enriquecimento n√£o dispon√≠vel', 'warning');
            }
        }
        
        function applyFiltersFixed(tab) {
            console.log(`üîß Aplicando filtros em: ${tab}`);
            
            if (window.pmgApp && window.pmgApp.applyFilters) {
                window.pmgApp.applyFilters(tab);
            }
        }
        
        function openAPIStatusModal() {
            const modal = document.getElementById('apiStatusModal');
            if (modal) {
                modal.style.display = 'flex';
                
                if (window.apiManager && window.apiManager.showStatusModal) {
                    window.apiManager.showStatusModal();
                }
            }
        }
        
        function closeAPIStatusModal() {
            const modal = document.getElementById('apiStatusModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function testAllAPIsFixed() {
            if (window.apiManager && window.apiManager.testAllAPIs) {
                window.apiManager.testAllAPIs();
                showToastFixed('Testando todas as APIs...', 'info');
            }
        }
        
        function refreshAPIStatusFixed() {
            if (window.apiManager && window.apiManager.testConnectivity) {
                window.apiManager.testConnectivity();
                showToastFixed('Atualizando status das APIs...', 'info');
            }
        }
        
        function closeAllModalsFixed() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
        }
        
        function showToastFixed(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateLoadingStatus(message, progress) {
            const statusElement = document.getElementById('loading-status');
            const barElement = document.getElementById('loading-bar');
            
            if (statusElement) statusElement.textContent = message;
            if (barElement) barElement.style.width = `${progress}%`;
        }
        
        // ============= INICIALIZA√á√ÉO =============
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM carregado, iniciando sistema com UPLOAD CORRIGIDO...');
            
            updateLoadingStatus('Carregando scripts...', 10);
            
            // Carregar scripts
            loadScriptsSequentially();
            
            // Aguardar scripts carregarem
            const initInterval = setInterval(() => {
                if (window.scriptsLoaded) {
                    clearInterval(initInterval);
                    initializeSystemFixed();
                }
            }, 500);
            
            // Timeout de seguran√ßa
            setTimeout(() => {
                if (!window.systemInitialized) {
                    clearInterval(initInterval);
                    console.warn('‚ö†Ô∏è Timeout no carregamento, tentando inicializar...');
                    initializeSystemFixed();
                }
            }, 15000);
        });
        
        async function initializeSystemFixed() {
            try {
                updateLoadingStatus('Inicializando sistema...', 50);
                
                // Aguardar um pouco mais
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateLoadingStatus('Testando APIs...', 70);
                
                // Testar APIs
                if (window.apiManager) {
                    await window.apiManager.testConnectivity();
                }
                
                updateLoadingStatus('Inicializando aplica√ß√£o...', 90);
                
                // Inicializar app principal
                if (window.PMGApp) {
                    window.pmgApp = new window.PMGApp();
                    await window.pmgApp.init();
                }
                
                updateLoadingStatus('Sistema pronto!', 100);
                
                // Ocultar tela de loading
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.style.opacity = '0';
                        setTimeout(() => {
                            loadingScreen.style.display = 'none';
                        }, 500);
                    }
                    window.systemInitialized = true;
                    
                    // Toast de sucesso
                    setTimeout(() => {
                        showToastFixed('‚úÖ Sistema 100% funcional!\nüîß Upload corrigido - bot√µes sempre vis√≠veis!\nüìë Navega√ß√£o entre abas funcionando!', 'success');
                    }, 1000);
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `
                        <div class="loading-content">
                            <div style="font-size: 48px; color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h3>Erro na Inicializa√ß√£o</h3>
                            <p>Erro: ${error.message}</p>
                            <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-top: 16px;">
                                üîÑ Recarregar Sistema
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // ============= FUN√á√ïES GLOBAIS COMPATIBILIDADE =============
        
        window.switchTab = switchTabFixed;
        window.uploadFile = openUploadModalFixed;
        window.processUpload = processUploadFixed;
        window.closeUploadModal = closeUploadModalFixed;
        window.handleFileSelect = handleFileSelectFixed;
        window.showAPIStatus = openAPIStatusModal;
        window.closeAPIStatusModal = closeAPIStatusModal;
        window.enrichData = enrichDataFixed;
        window.testAllAPIs = testAllAPIsFixed;
        window.refreshAPIStatus = refreshAPIStatusFixed;
        window.showToast = showToastFixed;
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registrado: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW falhou: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
